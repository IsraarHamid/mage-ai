from mage_ai.data_preparation.repo_manager import get_repo_path
from mage_ai.io.config import ConfigFileLoader
from mage_ai.io.snowflake import Snowflake
from snowflake.connector.pandas_tools import pd_writer
from sqlalchemy import create_engine
from sqlalchemy.dialects import registry
import functools

registry.register('snowflake', 'snowflake.sqlalchemy', 'dialect')
if 'transformer' not in globals():
    from mage_ai.data_preparation.decorators import transformer
if 'test' not in globals():
    from mage_ai.data_preparation.decorators import test


@transformer
def transform(data, *args, **kwargs):
    """
    Transform Snowflake data and create views.
    Specify your configuration settings in 'io_config.yaml'.

    Docs: https://docs.mage.ai/design/data-loading#snowflake
    """
    account_identifier = 'kjlcjth-zn58087'
    user = 'Israar'
    password = 'Israar$n0w'
    database_name = 'TEST'
    schema_name = 'RAW'

    conn_string = f"snowflake://{user}:{password}@{account_identifier}/{database_name}/{schema_name}"
    engine = create_engine(conn_string)

    df.to_sql(name=table_name.lower(), con=engine, if_exists=if_exists, method=functools.partial(pd_writer, quote_identifiers=False), index=False)



@test
def test_output(output, *args) -> None:
    """
    Template code for testing the output of the block.
    """
    assert output is not None, 'The output is undefined'
